<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>Pipedrive Field Mapping Configuration</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        .mapping-row {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
{% extends "base.html" %}

{% block title %}Field Mapping Configuration{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h2>Pipedrive Field Mapping</h2>
        <div class="alert alert-info">
            Configure how Abacus fields map to Pipedrive fields.
        </div>
        <div id="mappingContainer"></div>
        <button type="button" class="btn btn-primary mt-3" id="saveMapping">Save Mapping</button>
    </div>
</div>
{% endblock %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let companySelect;
    function initSelect() {
        companySelect = document.getElementById('companySelect');
    }
    let pipedriveFields = {
        organization: [],
        person: [],
        deal: []
    };
    const sourceFields = [
        'ProjNr', 'ProjName', 'NAME', 'VORNAME', 'EMAIL', 'TEL',
        'LAND', 'PLZ', 'ORT', 'STREET', 'HOUSE_NUMBER',
        'KDatum', 'KSumme', 'ADatum', 'ASumme'
    ];

    function createMappingRow(existingMapping = null) {
        const row = document.createElement('div');
        row.className = 'mapping-row row g-3 align-items-center';

        row.innerHTML = `
            <div class="col-md-4">
                <select class="form-select source-field" required>
                    <option value="">Select Source Field</option>
                    ${sourceFields.map(field =>
                        `<option value="${field}" ${existingMapping && existingMapping.source === field ? 'selected' : ''}>${field}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="col-md-4">
                <select class="form-select target-field" required>
                    <option value="">Select Pipedrive Field</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select entity-type" required>
                    <option value="organization" ${existingMapping && existingMapping.entity === 'organization' ? 'selected' : ''}>Organization</option>
                    <option value="person" ${existingMapping && existingMapping.entity === 'person' ? 'selected' : ''}>Person</option>
                    <option value="deal" ${existingMapping && existingMapping.entity === 'deal' ? 'selected' : ''}>Deal</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger remove-mapping">Ã—</button>
            </div>
        `;

        // Initialize select2 for the target field
        $(row).find('.target-field').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Select Pipedrive Field'
        });

        // Update options based on entity type
        const entitySelect = row.querySelector('.entity-type');
        const targetSelect = row.querySelector('.target-field');

        entitySelect.addEventListener('change', () => {
            const entityType = entitySelect.value;
            updateTargetFields(targetSelect, entityType);
        });

        // Initial population of fields
        updateTargetFields(targetSelect, entitySelect.value);

        return row;
    }

    function updateTargetFields(select, entityType) {
        select.innerHTML = '<option value="">Select Pipedrive Field</option>';
        const fields = pipedriveFields[entityType] || [];
        fields.forEach(field => {
            const option = new Option(field.name, field.key);
            select.add(option);
        });
        $(select).trigger('change');
    }

    async function fetchPipedriveFields() {
        try {
            const response = await fetch('/pipedrive-fields');
            const data = await response.json();
            pipedriveFields = data;

            // Update all existing rows
            document.querySelectorAll('.mapping-row').forEach(row => {
                const entitySelect = row.querySelector('.entity-type');
                const targetSelect = row.querySelector('.target-field');
                updateTargetFields(targetSelect, entitySelect.value);
            });
        } catch (error) {
            console.error('Error fetching Pipedrive fields:', error);
            alert('Failed to fetch Pipedrive fields');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('mappingContainer');
        const saveButton = document.getElementById('saveMapping');

        // Initial fetch of Pipedrive fields
        fetchPipedriveFields();
        const addButton = document.getElementById('addMapping'); //This ID is not in the new template, so it is commented out.
        //const form = document.getElementById('mappingForm'); //This ID is not in the new template, so it is commented out.

        // Load existing mappings
        fetch('/pipedrive-config')
            .then(response => response.json())
            .then(mappings => {
                if (mappings && mappings.length) {
                    mappings.forEach(mapping => {
                        container.appendChild(createMappingRow(mapping));
                    });
                } else {
                    container.appendChild(createMappingRow());
                }
            });

        //addButton.addEventListener('click', () => { //This event listener is commented out because the add button is not in the new template
        //    container.appendChild(createMappingRow());
        //});

        container.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-mapping')) {
                e.target.closest('.mapping-row').remove();
            }
        });

        saveButton.addEventListener('click', async (e) => { //This event listener replaces the previous form submission listener
            e.preventDefault();
            const mappings = Array.from(container.getElementsByClassName('mapping-row')).map(row => ({
                source: row.querySelector('.source-field').value,
                target: row.querySelector('.target-field').value,
                entity: row.querySelector('.entity-type').value
            }));

            const response = await fetch('/pipedrive-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(mappings)
            });

            if (response.ok) {
                alert('Configuration saved successfully!');
            } else {
                alert('Error saving configuration');
            }
        });
    });
</script>
</body>
</html>