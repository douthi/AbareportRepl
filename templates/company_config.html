{% extends "base.html" %}

{% block title %}{{ company|title }} Configuration{% endblock %}

{% block additional_styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .config-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    .config-section-header {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .config-section-body {
        padding: 1.5rem;
    }
    .mapping-row {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .mapping-row:hover {
        background: rgba(255, 255, 255, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- API Configuration Section -->
    <div class="config-section">
        <div class="config-section-header">
            <h4 class="mb-0">
                <i class="fas fa-key me-2"></i>
                API Configuration
            </h4>
        </div>
        <div class="config-section-body">
            <form id="apiConfigForm" class="needs-validation" novalidate>
                <div class="form-floating mb-3">
                    <input type="password" 
                           class="form-control bg-dark text-light" 
                           id="pipedriveKey" 
                           name="pipedrive_key" 
                           placeholder="Pipedrive API Key"
                           value="{{ config.COMPANIES[company]['pipedrive_api_key'] }}"
                           readonly
                           required>
                    <small class="text-muted">API key is managed through Secrets</small>
                    <label for="pipedriveKey">Pipedrive API Key</label>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save API Key
                </button>
            </form>
        </div>
    </div>

    <!-- Field Mapping Section -->
    <div class="config-section">
        <div class="config-section-header">
            <h4 class="mb-0">
                <i class="fas fa-exchange-alt me-2"></i>
                Field Mapping
            </h4>
        </div>
        <div class="config-section-body">
            <div id="fieldMappings">
                <div class="alert alert-info">
                    Please save a valid Pipedrive API key first to load available fields.
                </div>
                <div class="mapping-row row g-3 align-items-center mb-3">
                    <div class="col-md-3">
                        <select class="form-select source-field">
                            <option value="">Select Abacus Field</option>
                            <option value="ProjNr">Project Number</option>
                            <option value="ProjName">Project Name</option>
                            <option value="NAME">Name</option>
                            <option value="VORNAME">First Name</option>
                            <option value="EMAIL">Email</option>
                            <option value="TEL">Phone</option>
                            <option value="LAND">Country</option>
                            <option value="PLZ">Postal Code</option>
                            <option value="ORT">City</option>
                            <option value="STREET">Street</option>
                            <option value="HOUSE_NUMBER">House Number</option>
                            <option value="KDatum">Contract Date</option>
                            <option value="KSumme">Contract Amount</option>
                            <option value="ADatum">Order Date</option>
                            <option value="ASumme">Order Amount</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select entity-type">
                            <option value="">Select Entity Type</option>
                            <option value="organization">Organization</option>
                            <option value="person">Person</option>
                            <option value="deal">Deal</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select target-field" disabled>
                            <option value="">Select Pipedrive Field</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-danger remove-mapping">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-secondary me-2" id="addMapping">
                    <i class="fas fa-plus me-2"></i>Add New Mapping
                </button>
                <button type="button" class="btn btn-primary" id="saveMapping">
                    <i class="fas fa-save me-2"></i>Save Mappings
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
let pipedriveFields = {
    organization: [],
    person: [],
    deal: []
};

const sourceFields = [
    'ProjNr', 'ProjName', 'NAME', 'VORNAME', 'EMAIL', 'TEL',
    'LAND', 'PLZ', 'ORT', 'STREET', 'HOUSE_NUMBER',
    'KDatum', 'KSumme', 'ADatum', 'ASumme'
];

function createMappingRow(mapping = null) {
    const row = document.createElement('div');
    row.className = 'mapping-row';

    row.innerHTML = `
        <div class="row g-3">
            <div class="col-md-3">
                <select class="form-select source-field">
                    <option value="">Select Source Field</option>
                    ${sourceFields.map(field => 
                        `<option value="${field}" ${mapping && mapping.source === field ? 'selected' : ''}>${field}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select entity-type">
                    <option value="">Select Entity Type</option>
                    <option value="organization" ${mapping && mapping.entity === 'organization' ? 'selected' : ''}>Organization</option>
                    <option value="person" ${mapping && mapping.entity === 'person' ? 'selected' : ''}>Person</option>
                    <option value="deal" ${mapping && mapping.entity === 'deal' ? 'selected' : ''}>Deal</option>
                </select>
            </div>
            <div class="col-md-5">
                <select class="form-select target-field">
                    <option value="">Select Target Field</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger remove-mapping">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;

    const sourceSelect = row.querySelector('.source-field');
    const entitySelect = row.querySelector('.entity-type');
    const targetSelect = row.querySelector('.target-field');

    // Initialize Select2 for searchable dropdowns
    $(sourceSelect).select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Source Field'
    });

    $(entitySelect).select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Entity Type'
    });

    $(targetSelect).select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Target Field'
    });

    entitySelect.addEventListener('change', () => {
        updateTargetFields(targetSelect, entitySelect.value, mapping?.target);
    });

    if (mapping?.entity) {
        updateTargetFields(targetSelect, mapping.entity, mapping.target);
    }

    return row;
}

function updateTargetFields(select, entityType, selectedValue = null) {
    const fields = pipedriveFields[entityType] || [];
    $(select).empty().trigger('change');

    const options = fields.map(field => 
        new Option(field.name, field.key, false, field.key === selectedValue)
    );

    $(select).append(options).trigger('change');
}

async function loadMappings() {
    const container = document.getElementById('fieldMappings');
    container.innerHTML = '';

    try {
        const response = await fetch(`/{{ company }}/field-mappings`);
        const mappings = await response.json();

        if (mappings && mappings.length) {
            mappings.forEach(mapping => {
                container.appendChild(createMappingRow(mapping));
            });
        } else {
            container.appendChild(createMappingRow());
        }
    } catch (error) {
        console.error('Error loading mappings:', error);
        container.appendChild(createMappingRow());
    }
}

async function fetchPipedriveFields() {
    try {
        const response = await fetch(`/{{ company }}/pipedrive-fields`);
        if (!response.ok) {
            throw new Error('Failed to fetch Pipedrive fields');
        }
        const fields = await response.json();
        pipedriveFields = fields;
        
        // Clear any existing error messages
        const container = document.getElementById('fieldMappings');
        if (container.querySelector('.alert')) {
            container.querySelector('.alert').remove();
        }
        
        await loadMappings();
    } catch (error) {
        console.error('Error fetching Pipedrive fields:', error);
        showToast('Please ensure your API key is configured correctly', 'warning');
        
        const container = document.getElementById('fieldMappings');
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Please configure your Pipedrive API key first to load available fields.
            </div>`;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', fetchPipedriveFields);

// Event Listeners
document.getElementById('addMapping').addEventListener('click', () => {
    document.getElementById('fieldMappings').appendChild(createMappingRow());
});

document.getElementById('fieldMappings').addEventListener('click', (e) => {
    if (e.target.closest('.remove-mapping')) {
        const row = e.target.closest('.mapping-row');
        row.remove();
    }
});

document.getElementById('apiConfigForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch(`/{{ company }}/config`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showToast('API configuration saved successfully!');
            await fetchPipedriveFields();
        } else {
            showToast('Failed to save API configuration', 'danger');
        }
    } catch (error) {
        showToast('Error saving API configuration', 'danger');
    }
});

document.getElementById('saveMapping').addEventListener('click', async () => {
    const mappings = Array.from(document.querySelectorAll('.mapping-row')).map(row => ({
        source: $(row).find('.source-field').val(),
        target: $(row).find('.target-field').val(),
        entity: $(row).find('.entity-type').val()
    })).filter(mapping => mapping.source && mapping.target && mapping.entity);

    if (mappings.length === 0) {
        showToast('Please add at least one valid mapping', 'warning');
        return;
    }

    try {
        const response = await fetch(`/{{ company }}/field-mappings`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(mappings)
        });

        if (response.ok) {
            showToast('Field mappings saved successfully!');
            await loadMappings(); // Reload mappings to confirm changes
        } else {
            const error = await response.text();
            showToast(`Failed to save field mappings: ${error}`, 'danger');
        }
    } catch (error) {
        console.error('Error saving mappings:', error);
        showToast('Error saving field mappings', 'danger');
    }
});

function showToast(message, type = 'success') {
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');

    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}
</script>
{% endblock %}