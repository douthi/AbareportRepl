
{% extends "base.html" %}

{% block title %}{{ company|title }} Configuration{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">{{ company|title }} Configuration</h2>
        </div>
        <div class="card-body">
            <form id="apiConfigForm" class="mb-4">
                <div class="mb-4">
                    <h4 class="border-bottom pb-2">API Keys</h4>
                    <div class="mb-3">
                        <label class="form-label">Pipedrive API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" name="pipedrive_key" value="{{ config.COMPANIES[company]['pipedrive_api_key'] }}">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword(this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save API Key</button>
                </div>
            </form>

            <div>
                <h4 class="border-bottom pb-2">Field Mapping</h4>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Configure how Abacus fields map to Pipedrive fields
                </div>
                <div id="fieldMappings"></div>
                <button type="button" class="btn btn-primary mt-3" id="saveMapping">
                    <i class="fas fa-save me-2"></i>Save Mapping
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pipedriveFields = {
    organization: [],
    person: [],
    deal: []
};

const sourceFields = [
    'ProjNr', 'ProjName', 'NAME', 'VORNAME', 'EMAIL', 'TEL',
    'LAND', 'PLZ', 'ORT', 'STREET', 'HOUSE_NUMBER',
    'KDatum', 'KSumme', 'ADatum', 'ASumme'
];

function togglePassword(button) {
    const input = button.parentElement.querySelector('input');
    const icon = button.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

async function fetchPipedriveFields() {
    try {
        const response = await fetch(`/pipedrive-fields?company={{ company }}`);
        const fields = await response.json();
        pipedriveFields = fields;
        loadMappings();
    } catch (error) {
        console.error('Error fetching Pipedrive fields:', error);
    }
}

function createMappingRow(mapping = null) {
    const row = document.createElement('div');
    row.className = 'row g-3 align-items-center mb-3 border-bottom pb-3';
    row.innerHTML = `
        <div class="col-md-4">
            <select class="form-select source-field">
                ${sourceFields.map(field => 
                    `<option value="${field}" ${mapping && mapping.source === field ? 'selected' : ''}>${field}</option>`
                ).join('')}
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select entity-type">
                <option value="organization" ${mapping && mapping.entity === 'organization' ? 'selected' : ''}>Organization</option>
                <option value="person" ${mapping && mapping.entity === 'person' ? 'selected' : ''}>Person</option>
                <option value="deal" ${mapping && mapping.entity === 'deal' ? 'selected' : ''}>Deal</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select target-field"></select>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger remove-mapping">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    const entitySelect = row.querySelector('.entity-type');
    const targetSelect = row.querySelector('.target-field');

    entitySelect.addEventListener('change', () => {
        updateTargetFields(targetSelect, entitySelect.value);
    });

    updateTargetFields(targetSelect, entitySelect.value);
    return row;
}

function updateTargetFields(select, entityType) {
    select.innerHTML = pipedriveFields[entityType].map(field =>
        `<option value="${field.key}">${field.name}</option>`
    ).join('');
}

async function loadMappings() {
    const container = document.getElementById('fieldMappings');
    container.innerHTML = '';
    
    try {
        const response = await fetch(`/{{ company }}/field-mappings`);
        const mappings = await response.json();
        
        if (mappings && mappings.length) {
            mappings.forEach(mapping => {
                container.appendChild(createMappingRow(mapping));
            });
        } else {
            container.appendChild(createMappingRow());
        }
    } catch (error) {
        console.error('Error loading mappings:', error);
        container.appendChild(createMappingRow());
    }
}

document.addEventListener('DOMContentLoaded', fetchPipedriveFields);

document.getElementById('apiConfigForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch(`/{{ company }}/config`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Configuration saved successfully!');
        } else {
            alert('Failed to save configuration');
        }
    } catch (error) {
        alert('Error saving configuration');
    }
});

document.getElementById('saveMapping').addEventListener('click', async () => {
    const mappings = Array.from(document.getElementById('fieldMappings').children).map(row => ({
        source: row.querySelector('.source-field').value,
        target: row.querySelector('.target-field').value,
        entity: row.querySelector('.entity-type').value
    }));

    try {
        const response = await fetch(`/{{ company }}/field-mappings`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(mappings)
        });

        if (response.ok) {
            alert('Field mappings saved successfully!');
        } else {
            alert('Failed to save field mappings');
        }
    } catch (error) {
        alert('Error saving field mappings');
    }
});

document.getElementById('fieldMappings').addEventListener('click', (e) => {
    if (e.target.closest('.remove-mapping')) {
        e.target.closest('.row').remove();
    }
});
</script>
{% endblock %}
