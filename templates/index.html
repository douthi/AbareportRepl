<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>Abacus ERP Report Manager</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-new {
            color: var(--bs-info);
        }
        .status-synced {
            color: var(--bs-secondary);
        }
        .status-fresh-sync {
            color: var(--bs-success);
        }
        .btn-underline {
            text-decoration: underline;
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            color: var(--bs-secondary);
        }
        .btn-underline:hover {
            color: var(--bs-primary);
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <div class="container mt-4 flex-grow-1">
        <h1 class="mb-4">Uniska AG ERP Report Manager</h1>

        <!-- Selection Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="reportForm" method="POST" action="/startAllReports" class="row g-3">
                    <div class="col-md-6">
                        <label for="mandant" class="form-label">Mandant</label>
                        <select class="form-select" id="mandant" name="mandant" required>
                            <option value="">Select Mandant</option>
                            {% for id, name in config.SUPPORTED_MANDANTS.items() %}
                            <option value="{{ id }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="none">All Years</option>
                            {% for year in range(current_year, current_year - 5, -1) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Generate Reports</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" id="searchProjNr" class="form-control" placeholder="Search by ProjNr">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hideProcessed" checked>
                            <label class="form-check-label" for="hideProcessed">
                                Hide Synced Entries
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th data-sort="ProjNr" style="cursor: pointer">ProjNr <i class="fas fa-sort"></i></th>
                                <th data-sort="ProjName">Project Name</th>
                                <th data-sort="NAME">Name <i class="fas fa-sort"></i></th>
                                <th data-sort="KDatum" style="cursor: pointer">KDatum <i class="fas fa-sort"></i></th>
                                <th data-sort="KSumme" style="cursor: pointer">KSumme <i class="fas fa-sort"></i></th>
                                <th data-sort="ADatum" style="cursor: pointer">ADatum <i class="fas fa-sort"></i></th>
                                <th data-sort="ASumme" style="cursor: pointer">ASumme <i class="fas fa-sort"></i></th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-auto py-3">
        <div class="container text-center">
            <button id="pipedriveConnect" class="btn btn-underline">
                Add Pipedrive Connection
            </button>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchProjNr');
            const hideProcessedCheckbox = document.getElementById('hideProcessed');
            let currentData = [];
            let freshSyncs = new Set(); // Track items synced in current session

            // Pipedrive connection handler
            document.getElementById('pipedriveConnect').addEventListener('click', function() {
                if (confirm('Do you want to connect a Pipedrive account?')) {
                    const apiKey = prompt('Please enter your Pipedrive API key:');
                    if (apiKey) {
                        if (confirm('Are you sure you want to use this API key?')) {
                            // Here we would handle the API key, for now just show success
                            alert('Pipedrive connection successful!');
                        }
                    }
                }
            });

            // Load initial data
            fetch('/combinedData')
                .then(response => response.json())
                .then(data => {
                    currentData = data.combined_data.map(item => ({
                        ...item,
                        Status: item.Status || 'new'
                    }));
                    updateTable();
                });

            function getStatusClass(status, projNr) {
                if (freshSyncs.has(projNr)) return 'status-fresh-sync';
                switch (status.toLowerCase()) {
                    case 'synced': return 'status-synced';
                    case 'new': return 'status-new';
                    default: return '';
                }
            }

            // Search and filter function
            function updateTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const hideProcessed = hideProcessedCheckbox.checked;

                const filteredData = currentData.filter(item => {
                    const matchesSearch = item.ProjNr.toString().toLowerCase().includes(searchTerm);
                    const isSynced = item.Status.toLowerCase() === 'synced';
                    return matchesSearch && (!hideProcessed || !isSynced);
                });

                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = filteredData.map(item => `
                    <tr>
                        <td>${item.ProjNr || ''}</td>
                        <td>${item.ProjName || ''}</td>
                        <td>${item.NAME || ''}</td>
                        <td>${item.KDatum || ''}</td>
                        <td>${item.KSumme || ''}</td>
                        <td>${item.ADatum || ''}</td>
                        <td>${item.ASumme || ''}</td>
                        <td class="${getStatusClass(item.Status, item.ProjNr)}">${item.Status}</td>
                        <td>
                            ${item.Status.toLowerCase() === 'new' ? 
                                `<button class="btn btn-sm btn-outline-success sync-btn" data-projnr="${item.ProjNr}">
                                    Confirm Sync
                                </button>` : 
                                ''
                            }
                        </td>
                    </tr>
                `).join('');

                // Add event listeners to sync buttons
                document.querySelectorAll('.sync-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const projNr = this.dataset.projnr;
                        const item = currentData.find(i => i.ProjNr.toString() === projNr);
                        if (item) {
                            item.Status = 'synced';
                            freshSyncs.add(projNr);
                            updateTable();
                        }
                    });
                });
            }

            // Add event listeners
            searchInput.addEventListener('input', updateTable);
            hideProcessedCheckbox.addEventListener('change', updateTable);

            // Sorting functionality
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    const isDate = ['KDatum', 'ADatum'].includes(column);
                    const isNumber = ['KSumme', 'ASumme', 'ProjNr'].includes(column);

                    currentData.sort((a, b) => {
                        if (isDate) {
                            return new Date(a[column] || 0) - new Date(b[column] || 0);
                        } else if (isNumber) {
                            return parseFloat(a[column] || 0) - parseFloat(b[column] || 0);
                        } else {
                            return (a[column] || '').localeCompare(b[column] || '');
                        }
                    });

                    if (this.classList.contains('asc')) {
                        currentData.reverse();
                        this.classList.remove('asc');
                        this.classList.add('desc');
                    } else {
                        this.classList.remove('desc');
                        this.classList.add('asc');
                    }

                    updateTable();
                });
            });

            // Form submission
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const jsonData = Object.fromEntries(formData.entries());

                fetch('/startAllReports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        alert('Reports started successfully. Please wait while data is being processed.');
                        pollForUpdates();
                    }
                });
            });

            function pollForUpdates() {
                const interval = setInterval(() => {
                    fetch('/reports')
                        .then(response => response.json())
                        .then(data => {
                            const allFinished = data.reports.every(
                                report => report.status === 'FinishedSuccess' || report.status === 'FinishedError'
                            );

                            if (allFinished) {
                                clearInterval(interval);
                                fetch('/combinedData')
                                    .then(response => response.json())
                                    .then(data => {
                                        currentData = data.combined_data.map(item => ({
                                            ...item,
                                            Status: item.Status || 'new'
                                        }));
                                        updateTable();
                                    });
                            }
                        });
                }, 5000);
            }
        });
    </script>
</body>
</html>