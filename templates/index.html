<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    {% block head %}
    <title>{% block title %}{{ company|title }} - CRM Sync{% endblock %}</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    {% endblock %}
    {% block additional_styles %}
    <style>
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bs-dark);
            transition: .4s;
            border-radius: 30px;
            border: 2px solid var(--bs-secondary);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: var(--bs-light);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--bs-light);
        }
        input:checked + .slider:before {
            transform: translateX(30px);
            background-color: var(--bs-dark);
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .table-container {
            position: relative;
            min-height: 200px;
        }
        .btn-underline {
            text-decoration: underline;
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            color: var(--bs-secondary);
        }
        .btn-underline:hover {
            color: var(--bs-primary);
        }
    </style>
    {% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">
    {% block content %}
    <div class="container-fluid">
        

        <h1 class="mb-4">{{ company|title }} â€“ Abacus x CRM Sync</h1>

        <!-- Selection Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="reportForm" method="POST" action="/startAllReports" class="row g-3">
                    <div class="col-md-6">
                        <label for="mandant" class="form-label">Mandant</label>
                        <select class="form-select" id="mandant" name="mandant" required>
                            {% for id, name in config.COMPANIES[company]['mandants'].items() %}
                            <option value="{{ id }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="none">All Years</option>
                            {% for year in range(current_year, current_year - 5, -1) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Generate Reports
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" id="searchProjNr" class="form-control" placeholder="Search by ProjNr" list="projNrSuggestions">
                        <datalist id="projNrSuggestions"></datalist>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hideProcessed" checked>
                            <label class="form-check-label" for="hideProcessed">
                                Hide Synced Entries
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="exportBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-file-export me-2"></i>
                            <span class="btn-text">Export Data</span>
                            <span class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-container">
                    <div id="initialLoadingOverlay" class="loading-overlay">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-2"></div>
                            <p class="mb-0">Loading data...</p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th data-sort="ProjNr">ProjNr <i class="fas fa-sort"></i></th>
                                    <th>Project Name</th>
                                    <th data-sort="NAME">Name <i class="fas fa-sort"></i></th>
                                    <th data-sort="VORNAME">First Name <i class="fas fa-sort"></i></th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th data-sort="KDatum">KDatum <i class="fas fa-sort"></i></th>
                                    <th data-sort="KSumme">KSumme <i class="fas fa-sort"></i></th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="loadingIndicator" class="text-center mt-3 d-none">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2" id="loadingMessage">Processing reports...</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-4 text-center">
            <button id="pipedriveConnect" class="btn btn-underline">
                Add Pipedrive Connection
            </button>
            <a href="/pipedrive-config" class="btn btn-underline ms-3">
                Configure Field Mapping
            </a>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchProjNr');
        const hideProcessedCheckbox = document.getElementById('hideProcessed');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingMessage = document.getElementById('loadingMessage');
        const initialLoadingOverlay = document.getElementById('initialLoadingOverlay');
        const generateBtn = document.getElementById('generateBtn');
        const generateBtnSpinner = generateBtn.querySelector('.spinner-border');
        let currentData = [];
        let freshSyncs = new Set();
        let lastReportTime = 0;
        const REPORT_COOLDOWN = 300000;

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            htmlElement.setAttribute('data-bs-theme', savedTheme);
            themeToggle.checked = savedTheme === 'light';
        }
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'light' : 'dark';
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Pipedrive connection
        document.getElementById('pipedriveConnect').addEventListener('click', function() {
            if (confirm('Do you want to connect a Pipedrive account?')) {
                const apiKey = prompt('Please enter your Pipedrive API key:');
                if (apiKey && confirm('Are you sure you want to use this API key?')) {
                    alert('Pipedrive connection successful!');
                }
            }
        });

        // Load initial data
        fetch('/combinedData')
            .then(response => response.json())
            .then(data => {
                if (data && data.combined_data) {
                    currentData = data.combined_data.map(item => ({
                        ...item,
                        Status: item.Status || 'new'
                    }));
                    updateTable();
                    updateProjNrSuggestions();
                }
            })
            .finally(() => {
                initialLoadingOverlay.style.display = 'none';
            });

        function updateProjNrSuggestions() {
            const datalist = document.getElementById('projNrSuggestions');
            const uniqueProjNrs = [...new Set(currentData.map(item => item.ProjNr))].slice(0, 10);
            datalist.innerHTML = uniqueProjNrs
                .map(projNr => `<option value="${projNr}"></option>`)
                .join('');
        }

        function getStatusClass(status, projNr) {
            if (freshSyncs.has(projNr)) return 'text-success';
            return status.toLowerCase() === 'synced' ? 'text-secondary' : 'text-info';
        }

        function updateTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const hideProcessed = hideProcessedCheckbox.checked;
            const filteredData = currentData.filter(item => {
                const projNr = (item.ProjNr || '').toString().toLowerCase();
                const matchesSearch = projNr.includes(searchTerm);
                const isSynced = (item.Status || '').toLowerCase() === 'synced';
                return matchesSearch && (!hideProcessed || !isSynced);
            });

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = filteredData.map(item => `
                <tr>
                    <td>${item.ProjNr || ''}</td>
                    <td>${item.ProjName || ''}</td>
                    <td>${item.NAME || ''}</td>
                    <td>${item.VORNAME || ''}</td>
                    <td>${item.EMAIL || ''}</td>
                    <td>${item.TEL || ''}</td>
                    <td>${item.KDatum || ''}</td>
                    <td>${item.KSumme || ''}</td>
                    <td class="${getStatusClass(item.Status, item.ProjNr)}">${item.Status}</td>
                    <td>
                        ${item.Status.toLowerCase() === 'new' ? 
                            `<button class="btn btn-sm btn-primary sync-btn" data-projnr="${item.ProjNr}">
                                <span class="spinner-border spinner-border-sm d-none"></span>
                                <span class="btn-text">Sync</span>
                            </button>` : 
                            ''
                        }
                    </td>
                </tr>
            `).join('');

            // Add sync button handlers
            document.querySelectorAll('.sync-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const spinner = this.querySelector('.spinner-border');
                    const btnText = this.querySelector('.btn-text');
                    const projNr = this.dataset.projnr;

                    this.disabled = true;
                    spinner.classList.remove('d-none');
                    btnText.textContent = 'Syncing...';

                    setTimeout(() => {
                        const item = currentData.find(i => i.ProjNr.toString() === projNr);
                        if (item) {
                            item.Status = 'synced';
                            freshSyncs.add(projNr);
                            updateTable();
                        }
                    }, 1000);
                });
            });
        }

        // Event listeners
        searchInput.addEventListener('input', updateTable);
        hideProcessedCheckbox.addEventListener('change', updateTable);

        // Sorting
        document.querySelectorAll('th[data-sort]').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.sort;
                currentData.sort((a, b) => {
                    const aVal = a[column] || '';
                    const bVal = b[column] || '';
                    return aVal.toString().localeCompare(bVal.toString());
                });
                if (this.classList.contains('asc')) {
                    currentData.reverse();
                    this.classList.remove('asc');
                    this.classList.add('desc');
                } else {
                    this.classList.remove('desc');
                    this.classList.add('asc');
                }
                updateTable();
            });
        });

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const timeSinceLastReport = Date.now() - lastReportTime;
            if (timeSinceLastReport < REPORT_COOLDOWN) {
                const remainingSeconds = Math.ceil((REPORT_COOLDOWN - timeSinceLastReport) / 1000);
                alert(`Please wait ${remainingSeconds} seconds before generating new reports.`);
                return;
            }

            const formData = new FormData(this);
            const jsonData = Object.fromEntries(formData.entries());

            loadingIndicator.classList.remove('d-none');
            loadingMessage.textContent = 'Starting reports...';
            generateBtn.disabled = true;
            generateBtnSpinner.classList.remove('d-none');

            fetch('/startAllReports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    loadingIndicator.classList.add('d-none');
                    generateBtn.disabled = false;
                    generateBtnSpinner.classList.add('d-none');
                } else {
                    loadingMessage.textContent = 'Reports started successfully. Processing data...';
                    pollForUpdates();
                }
            });
        });

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            const button = this;
            const spinner = button.querySelector('.spinner-border');
            const btnText = button.querySelector('.btn-text');

            button.disabled = true;
            spinner.classList.remove('d-none');
            btnText.textContent = 'Exporting...';

            fetch('/export')
                .then(response => response.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'export.csv';
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('Failed to export data. Please try again.');
                })
                .finally(() => {
                    button.disabled = false;
                    spinner.classList.add('d-none');
                    btnText.textContent = 'Export Data';
                });
        });

        function pollForUpdates() {
            const interval = setInterval(() => {
                fetch('/reports')
                    .then(response => response.json())
                    .then(data => {
                        const allFinished = data.reports.every(
                            report => report.status === 'FinishedSuccess' || report.status === 'FinishedError'
                        );

                        if (allFinished) {
                            setTimeout(() => {
                                fetch('/combinedData')
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data?.combined_data?.length > 0) {
                                            currentData = data.combined_data.map(item => ({
                                                ...item,
                                                Status: item.Status || 'new'
                                            }));
                                            updateTable();
                                            updateProjNrSuggestions();
                                            clearInterval(interval);
                                            loadingIndicator.classList.add('d-none');
                                            generateBtn.disabled = false;
                                            generateBtnSpinner.classList.add('d-none');
                                            lastReportTime = Date.now();
                                        }
                                    });
                            }, 2000);
                        }
                    });
            }, 5000);
        }
    });
    </script>
    {% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>