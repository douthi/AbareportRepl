<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>Uniska AG – Abacus x CRM Sync</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root[data-bs-theme="dark"] {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --input-bg: #343a40;
            --input-color: #f8f9fa;
            --border-color: #495057;
        }

        :root[data-bs-theme="light"] {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --input-bg: #ffffff;
            --input-color: #212529;
            --border-color: #dee2e6;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .form-select, .form-control {
            background-color: var(--input-bg) !important;
            color: var(--input-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-bs-theme="light"] .form-control::placeholder {
            color: var(--bs-dark) !important;
        }

        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: white;
        }

        .status-new {
            color: var(--bs-info);
        }
        .status-synced {
            color: var(--bs-secondary);
        }
        .status-fresh-sync {
            color: var(--bs-success);
        }

        /* Theme-aware component styles */
        [data-bs-theme="dark"] .card,
        [data-bs-theme="dark"] .card-body,
        [data-bs-theme="dark"] .table-container {
            background-color: var(--bs-dark) !important;
            border-color: var(--bs-border-color) !important;
            color: var(--bs-light) !important;
        }

        [data-bs-theme="light"] .card,
        [data-bs-theme="light"] .card-body,
        [data-bs-theme="light"] .table-container {
            background-color: var(--bs-light) !important;
            border-color: var(--bs-border-color) !important;
            color: var(--bs-dark) !important;
        }

        .table {
            color: var(--bs-body-color);
            background-color: var(--bs-body-bg);
        }

        /* Dark theme form controls */
        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select,
        [data-bs-theme="dark"] select.form-select,
        [data-bs-theme="dark"] input.form-control {
            background-color: var(--bs-dark) !important;
            color: var(--bs-light) !important;
            border-color: var(--bs-border-color);
        }

        [data-bs-theme="dark"] .form-control:focus,
        [data-bs-theme="dark"] .form-select:focus {
            background-color: var(--bs-gray-800) !important;
            color: var(--bs-light) !important;
            border-color: var(--bs-primary);
        }

        [data-bs-theme="dark"] .form-control option,
        [data-bs-theme="dark"] .form-select option,
        [data-bs-theme="dark"] .form-select optgroup {
            background-color: var(--bs-gray-800) !important;
            color: var(--bs-light) !important;
        }

        [data-bs-theme="dark"] .form-select:hover option:hover,
        [data-bs-theme="dark"] .form-select option:checked {
            background-color: var(--bs-primary) !important;
            color: var(--bs-light) !important;
        }

        /* Dark theme buttons */
        [data-bs-theme="dark"] .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: var(--bs-light);
        }

        [data-bs-theme="dark"] .btn-primary:hover {
            background-color: var(--bs-primary-dark);
            border-color: var(--bs-primary-dark);
        }

        [data-bs-theme="dark"] .table thead th {
            background-color: var(--bs-dark);
            color: var(--bs-light);
            border-color: var(--bs-border-color);
        }

        [data-bs-theme="light"] .table thead th {
            background-color: var(--bs-light);
            color: var(--bs-dark);
            border-color: var(--bs-border-color);
        }

        .table tbody td {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }
        .form-control {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        .form-control:focus {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }

        .form-select {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        .card {
            background-color: var(--bs-body-bg);
            border-color: var(--bs-border-color);
        }

        .table {
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        .table tbody tr:hover {
            background-color: var(--bs-tertiary-bg);
        }

        .loading-overlay {
            background-color: rgba(var(--bs-dark-rgb), 0.7);
        }

        [data-bs-theme="light"] .loading-overlay {
            background-color: rgba(var(--bs-light-rgb), 0.7);
        }
        .btn-underline {
            text-decoration: underline;
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            color: var(--bs-secondary);
            transition: color 0.3s ease;
        }
        .btn-underline:hover {
            color: var(--bs-primary);
        }
        .spinner-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(var(--bs-dark-rgb), 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: background-color 0.3s ease;
        }
        .table-container {
            position: relative;
            min-height: 200px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-radius: var(--bs-border-radius);
        }

        .table-container .table {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }

        .table-container .loading-overlay {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bs-dark);
            transition: .4s;
            border-radius: 30px;
            border: 2px solid var(--bs-secondary);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: var(--bs-light);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--bs-light);
        }
        input:checked + .slider:before {
            transform: translateX(30px);
            background-color: var(--bs-dark);
        }
        .theme-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 6px;
            pointer-events: none;
            z-index: 1;
        }
        .theme-icons i {
            font-size: 14px;
            color: var(--bs-light);
            transition: color 0.3s ease;
        }
        input:checked + .slider .theme-icons i {
            color: var(--bs-dark);
        }
        /* Add smooth transitions for theme changes */
        * {
            transition: background-color 0.3s ease, 
                      color 0.3s ease,
                      border-color 0.3s ease;
        }
        /* Theme-aware table styles */
        .table {
            transition: color 0.3s ease, 
                       background-color 0.3s ease,
                       border-color 0.3s ease;
        }
        .table th {
            color: var(--bs-emphasis-color);
        }
        .table td {
            color: var(--bs-body-color);
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <div class="container mt-4 flex-grow-1">
        <!-- Theme Toggle -->
        <div class="theme-toggle">
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider">
                    <div class="theme-icons">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </div>
                </span>
            </label>
        </div>

        <h1 class="mb-4">Uniska AG – Abacus x CRM Sync</h1>

        <!-- Selection Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="reportForm" method="POST" action="/startAllReports" class="row g-3">
                    <div class="col-md-6">
                        <label for="mandant" class="form-label">Mandant</label>
                        <select class="form-select" id="mandant" name="mandant" required>
                            <option value="">Select Mandant</option>
                            {% for id, name in config.SUPPORTED_MANDANTS.items() %}
                            <option value="{{ id }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="none">All Years</option>
                            {% for year in range(current_year, current_year - 5, -1) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Generate Reports
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="position-relative">
                            <input type="text" id="searchProjNr" class="form-control" placeholder="Search by ProjNr" list="projNrSuggestions">
                            <datalist id="projNrSuggestions"></datalist>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hideProcessed" checked>
                            <label class="form-check-label" for="hideProcessed">
                                Hide Synced Entries
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="exportBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-file-export me-2"></i>
                            <span class="btn-text">Export Data</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="table-container">
                    <!-- Initial Data Loading Overlay -->
                    <div id="initialLoadingOverlay" class="loading-overlay">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-0">Loading data...</p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th data-sort="ProjNr" style="cursor: pointer">ProjNr <i class="fas fa-sort"></i></th>
                                    <th data-sort="ProjName">Project Name</th>
                                    <th data-sort="NAME">Name <i class="fas fa-sort"></i></th>
                                    <th data-sort="VORNAME">First Name <i class="fas fa-sort"></i></th>
                                    <th data-sort="EMAIL">Email</th>
                                    <th data-sort="TEL">Phone</th>
                                    <th data-sort="KDatum" style="cursor: pointer">KDatum <i class="fas fa-sort"></i></th>
                                    <th data-sort="KSumme" style="cursor: pointer">KSumme <i class="fas fa-sort"></i></th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Loading Indicator (Moved below table) -->
                <div id="loadingIndicator" class="text-center mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" id="loadingMessage">Processing reports...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-auto py-3">
        <div class="container text-center">
            <button id="pipedriveConnect" class="btn btn-underline">
                Add Pipedrive Connection
            </button>
            <a href="/pipedrive-config" class="btn btn-underline ms-3">
                Configure Field Mapping
            </a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchProjNr');
            const hideProcessedCheckbox = document.getElementById('hideProcessed');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingMessage = document.getElementById('loadingMessage');
            const initialLoadingOverlay = document.getElementById('initialLoadingOverlay');
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnSpinner = generateBtn.querySelector('.spinner-border');
            let currentData = [];
            let freshSyncs = new Set(); // Track items synced in current session

            // Pipedrive connection handler
            document.getElementById('pipedriveConnect').addEventListener('click', function() {
                if (confirm('Do you want to connect a Pipedrive account?')) {
                    const apiKey = prompt('Please enter your Pipedrive API key:');
                    if (apiKey) {
                        if (confirm('Are you sure you want to use this API key?')) {
                            // Here we would handle the API key, for now just show success
                            alert('Pipedrive connection successful!');
                        }
                    }
                }
            });

            // Load initial data
            fetch('/combinedData')
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    if (data && data.combined_data) {
                        currentData = data.combined_data.map(item => ({
                            ...item,
                            Status: item.Status || 'new'
                        }));
                        updateTable();
                        updateProjNrSuggestions();
                    } else {
                        console.error('Invalid data format received');
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                })
                .finally(() => {
                    initialLoadingOverlay.style.display = 'none';
                });

            function updateProjNrSuggestions() {
                const datalist = document.getElementById('projNrSuggestions');
                const uniqueProjNrs = [...new Set(currentData.map(item => item.ProjNr))];
                datalist.innerHTML = uniqueProjNrs
                    .map(projNr => `<option value="${projNr}"></option>`)
                    .join('');
            }

            function getStatusClass(status, projNr) {
                if (freshSyncs.has(projNr)) return 'status-fresh-sync';
                switch (status.toLowerCase()) {
                    case 'synced': return 'status-synced';
                    case 'new': return 'status-new';
                    default: return '';
                }
            }

            // Search and filter function
            function updateTable() {
                console.log('Updating table with data:', currentData);
                const searchTerm = searchInput.value.toLowerCase();
                const hideProcessed = hideProcessedCheckbox.checked;

                // Ensure currentData is an array
                const dataToFilter = Array.isArray(currentData) ? currentData : [];

                const filteredData = dataToFilter.filter(item => {
                    const projNr = item.ProjNr ? item.ProjNr.toString().toLowerCase() : '';
                    const matchesSearch = projNr.includes(searchTerm);
                    const isSynced = (item.Status || '').toLowerCase() === 'synced';
                    return matchesSearch && (!hideProcessed || !isSynced);
                });

                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = filteredData.map(item => `
                    <tr>
                        <td>${item.ProjNr || ''}</td>
                        <td>${item.ProjName || ''}</td>
                        <td>${item.NAME || ''}</td>
                        <td>${item.VORNAME || ''}</td>
                        <td>${item.EMAIL || ''}</td>
                        <td>${item.TEL || ''}</td>
                        <td>${item.KDatum || ''}</td>
                        <td>${item.KSumme || ''}</td>
                        <td class="${getStatusClass(item.Status, item.ProjNr)}">${item.Status}</td>
                        <td>
                            ${item.Status.toLowerCase() === 'new' ? 
                                `<button class="btn btn-sm btn-outline-success sync-btn" data-projnr="${item.ProjNr}">
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    <span class="btn-text">Confirm Sync</span>
                                </button>` : 
                                ''
                            }
                        </td>
                    </tr>
                `).join('');

                // Add event listeners to sync buttons
                document.querySelectorAll('.sync-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const spinner = this.querySelector('.spinner-border');
                        const btnText = this.querySelector('.btn-text');
                        const projNr = this.dataset.projnr;

                        // Disable button and show spinner
                        this.disabled = true;
                        spinner.classList.remove('d-none');
                        btnText.textContent = 'Syncing...';

                        // Simulate sync process with a delay
                        setTimeout(() => {
                            const item = currentData.find(i => i.ProjNr.toString() === projNr);
                            if (item) {
                                item.Status = 'synced';
                                freshSyncs.add(projNr);
                                updateTable();
                            }
                        }, 1000);
                    });
                });
            }

            // Add event listeners
            searchInput.addEventListener('input', updateTable);
            hideProcessedCheckbox.addEventListener('change', updateTable);

            // Sorting functionality
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    const isDate = ['KDatum', 'ADatum'].includes(column);
                    const isNumber = ['KSumme', 'ASumme', 'ProjNr'].includes(column);

                    currentData.sort((a, b) => {
                        if (isDate) {
                            return new Date(a[column] || 0) - new Date(b[column] || 0);
                        } else if (isNumber) {
                            return parseFloat(a[column] || 0) - parseFloat(b[column] || 0);
                        } else {
                            return (a[column] || '').localeCompare(b[column] || '');
                        }
                    });

                    if (this.classList.contains('asc')) {
                        currentData.reverse();
                        this.classList.remove('asc');
                        this.classList.add('desc');
                    } else {
                        this.classList.remove('desc');
                        this.classList.add('asc');
                    }

                    updateTable();
                });
            });

            // Form submission
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const jsonData = Object.fromEntries(formData.entries());

                // Show loading indicators
                loadingIndicator.classList.remove('d-none');
                loadingMessage.textContent = 'Starting reports...';
                generateBtn.disabled = true;
                generateBtnSpinner.classList.remove('d-none');

                fetch('/startAllReports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        loadingIndicator.classList.add('d-none');
                        generateBtn.disabled = false;
                        generateBtnSpinner.classList.add('d-none');
                    } else {
                        loadingMessage.textContent = 'Reports started successfully. Processing data...';
                        pollForUpdates();
                    }
                });
            });

            let lastReportTime = 0;
            const REPORT_COOLDOWN = 300000; // 300 seconds in milliseconds

            function pollForUpdates() {
                const interval = setInterval(() => {
                    fetch('/reports')
                        .then(response => response.json())
                        .then(data => {
                            const allFinished = data.reports.every(
                                report => report.status === 'FinishedSuccess' || report.status === 'FinishedError'
                            );

                            // Find report with most pages
                            let maxProgress = { current: 0, total: 0 };
                            data.reports.forEach(report => {
                                if (report.message) {
                                    const pageMatch = report.message.match(/page (\d+) for report/i);
                                    const totalMatch = report.message.match(/rows=(\d+)/i);
                                    if (pageMatch && totalMatch) {
                                        const currentPage = parseInt(pageMatch[1]);
                                        const totalRows = parseInt(totalMatch[1]);
                                        const totalPages = Math.ceil(totalRows / 200); // Assuming 200 rows per page
                                        if (totalPages > maxProgress.total) {
                                            maxProgress = { current: currentPage, total: totalPages };
                                        }
                                    }
                                }
                            });

                            // Calculate and display progress
                            if (maxProgress.total > 0) {
                                const percent = Math.round((maxProgress.current / maxProgress.total) * 100);
                                loadingMessage.textContent = `Processing reports... Page ${maxProgress.current}/${maxProgress.total} (${percent}%)`;
                            }

                            if (allFinished) {
                                // Wait a moment for backend processing to complete
                                setTimeout(() => {
                                    fetch('/combinedData')
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data && data.combined_data) {
                                                currentData = data.combined_data.map(item => ({
                                                    ...item,
                                                    Status: item.Status || 'new'
                                                }));
                                                updateTable();
                                                updateProjNrSuggestions();
                                            }
                                            clearInterval(interval);
                                            loadingIndicator.classList.add('d-none');
                                            generateBtn.disabled = false;
                                            generateBtnSpinner.classList.add('d-none');
                                            lastReportTime = Date.now();
                                        })
                                        .catch(error => {
                                            console.error('Error fetching combined data:', error);
                                        });
                                }, 2000); // Wait 2 seconds after reports finish
                            }
                        });
                }, 5000);
            }

            // Update form submission handler to check cooldown
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const timeSinceLastReport = Date.now() - lastReportTime;
                if (timeSinceLastReport < REPORT_COOLDOWN) {
                    const remainingSeconds = Math.ceil((REPORT_COOLDOWN - timeSinceLastReport) / 1000);
                    alert(`Please wait ${remainingSeconds} seconds before generating new reports.`);
                    return;
                }

                const formData = new FormData(this);
                const jsonData = Object.fromEntries(formData.entries());

                loadingIndicator.classList.remove('d-none');
                loadingMessage.textContent = 'Starting reports...';
                generateBtn.disabled = true;
                generateBtnSpinner.classList.remove('d-none');

                fetch('/startAllReports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        loadingIndicator.classList.add('d-none');
                        generateBtn.disabled = false;
                        generateBtnSpinner.classList.add('d-none');
                    } else {
                        loadingMessage.textContent = 'Reports started successfully. Processing data...';
                        pollForUpdates();
                    }
                });
            });

            // Added export button functionality
            document.getElementById('exportBtn').addEventListener('click', function() {
                const button = this;
                const spinner = button.querySelector('.spinner-border');
                const btnText = button.querySelector('.btn-text');

                // Disable button and show spinner
                button.disabled = true;
                spinner.classList.remove('d-none');
                btnText.textContent = 'Exporting...';

                // Trigger file download
                fetch('/export')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Export failed');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = response.headers.get('content-disposition')?.split('filename=')[1] || 'export.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    })
                    .catch(error => {
                        console.error('Export error:', error);
                        alert('Failed to export data. Please try again.');
                    })
                    .finally(() => {
                        // Reset button state
                        button.disabled = false;
                        spinner.classList.add('d-none');
                        btnText.textContent = 'Export Data';
                    });
            });

            // Theme toggle functionality
            const themeToggle = document.getElementById('themeToggle');
            const htmlElement = document.documentElement;

            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlElement.setAttribute('data-bs-theme', savedTheme);
                themeToggle.checked = savedTheme === 'light';
            }

            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'light' : 'dark';
                htmlElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        });
    </script>
</body>
</html>