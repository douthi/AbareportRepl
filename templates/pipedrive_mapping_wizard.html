{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Company selection and header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Pipedrive Field Mapping Wizard</h2>
                    <p class="lead mb-0">Map your data fields to Pipedrive fields in 4 simple steps</p>
                </div>
                <div class="company-selector">
                    <label class="form-label">Select Company:</label>
                    <select class="form-select" id="companySelector">
                        {% for company in companies %}
                        <option value="{{ company }}" {% if company == current_company %}selected{% endif %}>
                            {{ company|upper }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Main wizard card -->
            <div class="card">
                <div class="card-body">
                    <!-- Progress bar -->
                    <div class="wizard-progress mb-4">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="steps d-flex justify-content-between">
                            <span class="step active" title="Map organization fields">Organizations</span>
                            <span class="step" title="Map contact person fields">Contacts</span>
                            <span class="step" title="Map deal fields">Deals</span>
                            <span class="step" title="Configure sync settings">Settings</span>
                        </div>
                    </div>

                    <!-- Dynamic content area -->
                    <div id="wizardContent">
                        <!-- Step content will be loaded here -->
                    </div>

                    <!-- Loading indicator -->
                    <div id="loadingSpinner" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading fields from Pipedrive...</p>
                    </div>

                    <!-- Field preview section -->
                    <div id="fieldPreview" class="mt-4 d-none">
                        <h5>Selected Field Preview</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-3">Field Name:</dt>
                                    <dd class="col-sm-9" id="previewFieldName">-</dd>
                                    <dt class="col-sm-3">Type:</dt>
                                    <dd class="col-sm-9" id="previewFieldType">-</dd>
                                    <dt class="col-sm-3">Required:</dt>
                                    <dd class="col-sm-9" id="previewRequired">-</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- Current mappings table -->
                    <div class="mapping-table mt-4">
                        <h5>Current Mappings</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Source Field</th>
                                        <th>Target Field</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mappingTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Navigation buttons -->
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-secondary" id="prevStep">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" id="nextStep">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="btn btn-success d-none" id="finishWizard">
                        <i class="fas fa-check"></i> Finish
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Field mapping modal -->
<div class="modal fade" id="fieldMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Map Fields</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Select a source field from your data and map it to a corresponding Pipedrive field.
                </div>
                <form id="fieldMappingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Source Field</label>
                                <select class="form-select" id="sourceField" required>
                                    <option value="">Select source field...</option>
                                </select>
                                <div class="form-text">Field from your data</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target Pipedrive Field</label>
                                <select class="form-select" id="targetField" required>
                                    <option value="">Select target field...</option>
                                </select>
                                <div class="form-text">Field in Pipedrive</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMapping">
                    <i class="fas fa-save"></i> Save Mapping
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 0;
const steps = ['organization', 'person', 'deal', 'settings'];
let entityFields = {};
let currentMappings = {};
let currentCompany = '{{ current_company }}';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing wizard');
    initializeWizard();
});

async function initializeWizard() {
    console.log('Setting up event listeners');

    // Initialize event listeners
    document.getElementById('prevStep').addEventListener('click', previousStep);
    document.getElementById('nextStep').addEventListener('click', nextStep);
    document.getElementById('finishWizard').addEventListener('click', finishWizard);
    document.getElementById('saveMapping').addEventListener('click', saveFieldMapping);

    // Add company selector listener
    document.getElementById('companySelector').addEventListener('change', function() {
        console.log('Company changed to:', this.value);
        currentCompany = this.value;
        window.location.href = `/pipedrive/wizard?company=${currentCompany}`;
    });

    // Set up field preview listeners
    document.getElementById('targetField').addEventListener('change', showFieldPreview);

    // Load initial step
    console.log('Loading initial step');
    await loadStepContent(currentStep);
    updateProgressBar();
}

async function loadStepContent(stepIndex) {
    const entityType = steps[stepIndex];
    const wizardContent = document.getElementById('wizardContent');

    try {
        showLoading(true);
        console.log(`Loading step content for ${entityType} - Company: ${currentCompany}`);
        const response = await fetch(`/pipedrive/wizard/step/${entityType}?company=${currentCompany}`);
        wizardContent.innerHTML = await response.text();

        // Load existing mappings first
        console.log('Loading existing mappings');
        await loadExistingMappings(entityType);

        // Update UI state
        document.getElementById('prevStep').disabled = stepIndex === 0;
        document.getElementById('nextStep').style.display = 
            stepIndex === steps.length - 1 ? 'none' : 'inline-block';
        document.getElementById('finishWizard').style.display = 
            stepIndex === steps.length - 1 ? 'inline-block' : 'none';

        // Refresh field dropdowns
        console.log('Loading entity fields');
        await loadEntityFields(entityType);

        console.log(`Step content loaded for ${entityType}`);
    } catch (error) {
        console.error(`Error loading step content: ${error}`);
        showError(`Error loading step content: ${error}`);
    } finally {
        showLoading(false);
    }
}

async function loadEntityFields(entityType) {
    try {
        showLoading(true);
        console.log(`Loading fields for ${entityType} - Company: ${currentCompany}`);
        const response = await fetch(`/pipedrive/api/available_fields/${entityType}?company=${currentCompany}`);
        const data = await response.json();

        if (data.success) {
            entityFields[entityType] = data.fields;
            console.log(`Loaded ${data.fields.length} fields for ${entityType}`);
            populateFieldDropdowns(entityType);
        } else {
            showError(`Failed to load ${entityType} fields: ${data.error}`);
            console.error(`Error loading fields: ${data.error}`);
        }
    } catch (error) {
        console.error(`Error loading fields: ${error}`);
        showError(`Error loading fields: ${error}`);
    } finally {
        showLoading(false);
    }
}

function showLoading(show) {
    document.getElementById('loadingSpinner').classList.toggle('d-none', !show);
}

function showFieldPreview() {
    const targetField = document.getElementById('targetField');
    const selectedField = entityFields[steps[currentStep]]?.find(
        f => f.id === targetField.value
    );

    if (selectedField) {
        document.getElementById('fieldPreview').classList.remove('d-none');
        document.getElementById('previewFieldName').textContent = selectedField.name;
        document.getElementById('previewFieldType').textContent = selectedField.field_type;
        document.getElementById('previewRequired').textContent = 
            selectedField.mandatory_flag ? 'Yes' : 'No';
    } else {
        document.getElementById('fieldPreview').classList.add('d-none');
    }
}

function populateFieldDropdowns(entityType) {
    console.log(`Populating dropdowns for ${entityType}`);
    const sourceSelect = document.getElementById('sourceField');
    const targetSelect = document.getElementById('targetField');

    if (!sourceSelect || !targetSelect) {
        console.error('Dropdown elements not found');
        return;
    }

    // Clear existing options
    sourceSelect.innerHTML = '<option value="">Select source field...</option>';
    targetSelect.innerHTML = '<option value="">Select target field...</option>';

    // Add source fields (from your data source)
    const sourceFields = getSourceFields(entityType);
    console.log(`Found ${sourceFields.length} source fields`);
    sourceFields.forEach(field => {
        const option = document.createElement('option');
        option.value = field.key;
        option.textContent = `${field.name} (${field.key})`;
        sourceSelect.appendChild(option);
    });

    // Add target fields (from Pipedrive)
    const fields = entityFields[entityType] || [];
    console.log(`Found ${fields.length} target fields`);
    fields.forEach(field => {
        const option = document.createElement('option');
        option.value = field.id;
        option.textContent = `${field.name} (${field.field_type})`;
        targetSelect.appendChild(option);
    });
}

async function loadExistingMappings(entityType) {
    try {
        showLoading(true);
        console.log(`Loading mappings for ${entityType} - Company: ${currentCompany}`);
        const response = await fetch(`/pipedrive/api/mappings/${entityType}?company=${currentCompany}`);
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
            currentMappings[entityType] = data.mappings || [];
            console.log(`Loaded ${currentMappings[entityType].length} mappings`);
            updateMappingTable(entityType);
        } else {
            showError(`Error loading mappings: ${data.error}`);
            console.error('Error from server:', data.error);
        }
    } catch (error) {
        showError(`Error loading mappings: ${error}`);
        console.error('Error loading mappings:', error);
    } finally {
        showLoading(false);
    }
}

function updateMappingTable(entityType) {
    console.log(`Updating table for ${entityType}`);
    console.log('Current mappings:', currentMappings[entityType]);

    const tableBody = document.getElementById('mappingTableBody');
    if (!tableBody) {
        console.error('Table body element not found');
        return;
    }

    tableBody.innerHTML = '';
    const mappings = currentMappings[entityType] || [];
    console.log(`Found ${mappings.length} mappings to display`);

    if (mappings.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" class="text-center text-muted">
                <i class="fas fa-info-circle"></i> No mappings defined yet. 
                Click the "Add Field Mapping" button above to start mapping fields.
            </td>
        `;
        tableBody.appendChild(row);
        return;
    }

    mappings.forEach((mapping, index) => {
        const targetField = entityFields[entityType]?.find(f => f.id === mapping.target);
        console.log(`Mapping ${index}:`, mapping, 'Target field:', targetField);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${mapping.source}</td>
            <td>${targetField?.name || mapping.target}</td>
            <td>${targetField?.field_type || 'Unknown'}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteMapping('${entityType}', ${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

async function saveFieldMapping() {
    const entityType = steps[currentStep];
    const sourceField = document.getElementById('sourceField').value;
    const targetField = document.getElementById('targetField').value;

    if (!sourceField || !targetField) {
        showError('Please select both source and target fields');
        return;
    }

    try {
        showLoading(true);
        console.log(`Saving mapping - Entity: ${entityType}, Source: ${sourceField}, Target: ${targetField}`);
        const response = await fetch(`/pipedrive/api/mapping?company=${currentCompany}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                entity: entityType,
                source: sourceField,
                target: targetField
            })
        });

        const data = await response.json();
        console.log('Save mapping response:', data);

        if (data.success) {
            await loadExistingMappings(entityType);
            bootstrap.Modal.getInstance(document.getElementById('fieldMappingModal')).hide();
        } else {
            showError(data.error);
        }
    } catch (error) {
        console.error('Error saving mapping:', error);
        showError(`Error saving mapping: ${error}`);
    } finally {
        showLoading(false);
    }
}

function updateProgressBar() {
    const progressBar = document.querySelector('.progress-bar');
    const progress = ((currentStep + 1) / steps.length) * 100;
    progressBar.style.width = `${progress}%`;

    // Update step indicators
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.toggle('active', index === currentStep);
        step.classList.toggle('completed', index < currentStep);
    });
}

function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.card-body').insertBefore(alertDiv, document.getElementById('wizardContent'));

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        bootstrap.Alert.getOrCreateInstance(alertDiv).close();
    }, 5000);
}

async function nextStep() {
    if (currentStep < steps.length - 1) {
        currentStep++;
        await loadStepContent(currentStep);
        updateProgressBar();
    }
}

async function previousStep() {
    if (currentStep > 0) {
        currentStep--;
        await loadStepContent(currentStep);
        updateProgressBar();
    }
}

async function finishWizard() {
    try {
        showLoading(true);
        const response = await fetch(`/pipedrive/wizard/finish?company=${currentCompany}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentMappings)
        });

        const data = await response.json();
        if (data.success) {
            window.location.href = '/pipedrive/config';
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError(`Error finishing wizard: ${error}`);
    } finally {
        showLoading(false);
    }
}

async function deleteMapping(entityType, index) {
    try {
        showLoading(true);
        console.log(`Deleting mapping - Entity: ${entityType}, Index: ${index}`);
        const response = await fetch(`/pipedrive/api/mapping/${entityType}/${index}?company=${currentCompany}`, {
            method: 'DELETE'
        });

        const data = await response.json();
        console.log('Delete response:', data);

        if (data.success) {
            await loadExistingMappings(entityType);
        } else {
            showError(data.error);
        }
    } catch (error) {
        console.error('Error deleting mapping:', error);
        showError(`Error deleting mapping: ${error}`);
    } finally {
        showLoading(false);
    }
}

function getSourceFields(entityType) {
    const fieldMappings = {
        organization: [
            { key: 'ADR_NAME', name: 'Organization Name' },
            { key: 'ADR_STREET', name: 'Street Address' },
            { key: 'ADR_PLZ', name: 'Postal Code' },
            { key: 'ADR_ORT', name: 'City' },
            { key: 'ADR_LAND', name: 'Country' },
            { key: 'ADR_EMAIL', name: 'Email' },
            { key: 'ADR_TEL', name: 'Phone' },
            { key: 'ADR_WWW', name: 'Website' }
        ],
        person: [
            { key: 'AKP_NAME', name: 'Last Name' },
            { key: 'AKP_VORNAME', name: 'First Name' },
            { key: 'AKP_MAIL', name: 'Email' },
            { key: 'AKP_TEL', name: 'Phone' },
            { key: 'AKP_FUNKTION', name: 'Job Title' },
            { key: 'ANR_ANREDE', name: 'Salutation' },
            { key: 'ANR_ANREDETEXT', name: 'Salutation Text' }
        ],
        deal: [
            { key: 'NPO_ProjNr', name: 'Project Number' },
            { key: 'NPO_ProjName', name: 'Project Name' },
            { key: 'NPO_KSumme', name: 'Initial Amount' },
            { key: 'NPO_ASumme', name: 'Final Amount' },
            { key: 'NPO_KDatum', name: 'Start Date' },
            { key: 'NPO_ADatum', name: 'End Date' },
            { key: 'NPO_Status', name: 'Deal Status' }
        ]
    };

    return fieldMappings[entityType] || [];
}
</script>
{% endblock %}