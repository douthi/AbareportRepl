1. ANR Field Handling Fix (pipedrive_helper.py)
Problem: ANR fields were incorrectly mapped to deals instead of persons and had source/target mismatches.

Solution:

python
Copy
# In create_person() method:
# Replace this section:
if field_info and field_info['type'] == 'enum':
    if mapping['source'] in ['ANR_ANREDE']:
        # Map salutations directly as custom field
        person_data[mapping['target']] = field_value
    elif mapping['source'] == 'ANR_ANREDETEXT':
        # Add Anredetext as custom field
        person_data['2fea5d7de9997e5a2e32befbe45bf8a145373754'] = field_value

# With this corrected version:
if field_info and field_info['type'] == 'enum':
    # Directly map using the field mapping configuration
    person_data[mapping['target']] = field_value
2. Remove Incorrect Deal Field Assignments (pipedrive_helper.py)
Problem: ANR fields were incorrectly added to deal data.

Solution:

python
Copy
# In create_deal() method:
# Remove these lines:
if anr_nr:
    deal_data['031ae26196cff3bf754a3fa9ff701f13c73113bf'] = str(anr_nr)
if anredetext:
    deal_data['2fea5d7de9997e5a2e32befbe45bf8a145373754'] = anredetext
3. Simplified Deal Status Handling (pipedrive_helper.py)
Problem: Overly complex status sequencing and manual time setting.

Solution:

python
Copy
# Replace the entire status handling block after deal creation with:
if result.get('success'):
    deal_id = result['data']['id']
    update_endpoint = f"{self.base_url}/deals/{deal_id}"

    # Set final status in single update
    status_data = {}
    if data.get('NPO_ASumme'):
        status_data['status'] = 'won'
    elif str(data.get('Status')) == '4':
        status_data['status'] = 'lost'
    
    if status_data:
        requests.put(update_endpoint, params=params, json=status_data)
4. Field Mapping Validation (uniska_field_mappings.json)
Verification: Ensure all mappings align with Pipedrive field IDs. Current mappings are correct based on the provided configuration.

5. Add Field Mapping Debugging (pipedrive_helper.py)
Problem: Need better visibility into mapping errors.

Solution: Add this to field loading:

python
Copy
def _load_field_mappings(self):
    """Load field mappings from file."""
    try:
        with open(self.mapping_file, 'r') as f:
            self.field_mappings = json.load(f)
        logger.debug(f"Loaded field mappings: {self.field_mappings}")  # Add this line
    except (FileNotFoundError, json.JSONDecodeError) as e:
        logger.error(f"Error loading field mappings: {str(e)}")
        self.field_mappings = []
Critical Implementation Notes:
Data Flow Order: Ensure the sequence remains:
Organization → Person → Deal

API Timing: Remove all time.sleep() calls - they're not reliable

Error Handling: Add validation before API calls:

python
Copy
if not self.api_key:
    raise ValueError("Pipedrive API key not configured")
These changes will resolve:

ANR field mapping inconsistencies

Incorrect deal field assignments

Overly complex status handling

Potential timing issues

Field mapping validation problems