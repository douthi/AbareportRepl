<body class="d-flex flex-column min-vh-100">
    
    <div class="container mt-4 flex-grow-1">
        <!-- Theme Toggle -->
        <div class="theme-toggle">
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider">
                    <div class="theme-icons">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </div>
                </span>
            </label>
        </div>

        <h1 class="mb-4">Uniska â€“ Abacus x CRM Sync</h1>

        <!-- Selection Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="reportForm" method="POST" action="/startAllReports" class="row g-3">
                    <div class="col-md-6">
                        <label for="mandant" class="form-label">Mandant</label>
                        <select class="form-select" id="mandant" name="mandant" required="">
                            
                            <option value="19">Uniska Interiors</option>
                            
                            <option value="20">Uniska AG</option>
                            
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="none">All Years</option>
                            
                            <option value="2025">2025</option>
                            
                            <option value="2024">2024</option>
                            
                            <option value="2023">2023</option>
                            
                            <option value="2022">2022</option>
                            
                            <option value="2021">2021</option>
                            
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Generate Reports
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row" data-dashlane-rid="f4f5777a71f620a2">
                    <div class="col-md-4">
                        <div class="position-relative">
                            <input type="text" id="searchProjNr" class="form-control" placeholder="Search by ProjNr" list="projNrSuggestions" data-dashlane-rid="ad15072eb1f31a12">
                            <datalist id="projNrSuggestions"></datalist>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hideProcessed" checked="" data-dashlane-rid="b13e1bc46f6fcdcd">
                            <label class="form-check-label" for="hideProcessed">
                                Hide Synced Entries
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="exportBtn" class="btn btn-outline-secondary" data-dashlane-label="true" data-dashlane-rid="1b66163c19ce88c4">
                            <i class="fas fa-file-export me-2"></i>
                            <span class="btn-text">Export Data</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="table-container">
                    <!-- Initial Data Loading Overlay -->
                    <div id="initialLoadingOverlay" class="loading-overlay" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-0">Loading data...</p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th data-sort="ProjNr" style="cursor: pointer">ProjNr <i class="fas fa-sort"></i></th>
                                    <th data-sort="ProjName">Project Name</th>
                                    <th data-sort="NAME">Name <i class="fas fa-sort"></i></th>
                                    <th data-sort="VORNAME">First Name <i class="fas fa-sort"></i></th>
                                    <th data-sort="EMAIL">Email</th>
                                    <th data-sort="TEL">Phone</th>
                                    <th data-sort="KDatum" style="cursor: pointer">KDatum <i class="fas fa-sort"></i></th>
                                    <th data-sort="KSumme" style="cursor: pointer">KSumme <i class="fas fa-sort"></i></th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Loading Indicator (Moved below table) -->
                <div id="loadingIndicator" class="text-center mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" id="loadingMessage">Processing reports...</p>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Footer -->
    <footer class="mt-auto py-3">
        <div class="container text-center">
            <button id="pipedriveConnect" class="btn btn-underline">
                Add Pipedrive Connection
            </button>
            <a href="/pipedrive-config" class="btn btn-underline ms-3">
                Configure Field Mapping
            </a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchProjNr');
            const hideProcessedCheckbox = document.getElementById('hideProcessed');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingMessage = document.getElementById('loadingMessage');
            const initialLoadingOverlay = document.getElementById('initialLoadingOverlay');
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnSpinner = generateBtn.querySelector('.spinner-border');
            let currentData = [];
            let freshSyncs = new Set(); // Track items synced in current session

            // Pipedrive connection handler
            document.getElementById('pipedriveConnect').addEventListener('click', function() {
                if (confirm('Do you want to connect a Pipedrive account?')) {
                    const apiKey = prompt('Please enter your Pipedrive API key:');
                    if (apiKey) {
                        if (confirm('Are you sure you want to use this API key?')) {
                            // Here we would handle the API key, for now just show success
                            alert('Pipedrive connection successful!');
                        }
                    }
                }
            });

            // Load initial data
            fetch('/combinedData')
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    if (data && data.combined_data) {
                        currentData = data.combined_data.map(item => ({
                            ...item,
                            Status: item.Status || 'new'
                        }));
                        updateTable();
                        updateProjNrSuggestions();
                    } else {
                        console.error('Invalid data format received');
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                })
                .finally(() => {
                    initialLoadingOverlay.style.display = 'none';
                });

            function updateProjNrSuggestions() {
                const datalist = document.getElementById('projNrSuggestions');
                const uniqueProjNrs = [...new Set(currentData.map(item => item.ProjNr))].slice(0, 10);
                datalist.innerHTML = uniqueProjNrs
                    .map(projNr => `<option value="${projNr}"></option>`)
                    .join('');
            }

            function getStatusClass(status, projNr) {
                if (freshSyncs.has(projNr)) return 'status-fresh-sync';
                switch (status.toLowerCase()) {
                    case 'synced': return 'status-synced';
                    case 'new': return 'status-new';
                    default: return '';
                }
            }

            // Search and filter function
            function updateTable() {
                console.log('Updating table with data:', currentData);
                const searchTerm = searchInput.value.toLowerCase();
                const hideProcessed = hideProcessedCheckbox.checked;

                // Ensure currentData is an array
                const dataToFilter = Array.isArray(currentData) ? currentData : [];

                const filteredData = dataToFilter.filter(item => {
                    const projNr = item.ProjNr ? item.ProjNr.toString().toLowerCase() : '';
                    const matchesSearch = projNr.includes(searchTerm);
                    const isSynced = (item.Status || '').toLowerCase() === 'synced';
                    return matchesSearch && (!hideProcessed || !isSynced);
                });

                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = filteredData.map(item => `
                    <tr>
                        <td>${item.ProjNr || ''}</td>
                        <td>${item.ProjName || ''}</td>
                        <td>${item.NAME || ''}</td>
                        <td>${item.VORNAME || ''}</td>
                        <td>${item.EMAIL || ''}</td>
                        <td>${item.TEL || ''}</td>
                        <td>${item.KDatum || ''}</td>
                        <td>${item.KSumme || ''}</td>
                        <td class="${getStatusClass(item.Status, item.ProjNr)}">${item.Status}</td>
                        <td>
                            ${item.Status.toLowerCase() === 'new' ? 
                                `<button class="btn btn-sm btn-primary sync-btn" data-projnr="${item.ProjNr}">
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    <span class="btn-text text-light">Confirm Sync</span>
                                </button>` : 
                                ''
                            }
                        </td>
                    </tr>
                `).join('');

                // Add event listeners to sync buttons
                document.querySelectorAll('.sync-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const spinner = this.querySelector('.spinner-border');
                        const btnText = this.querySelector('.btn-text');
                        const projNr = this.dataset.projnr;

                        // Disable button and show spinner
                        this.disabled = true;
                        spinner.classList.remove('d-none');
                        btnText.textContent = 'Syncing...';

                        // Simulate sync process with a delay
                        setTimeout(() => {
                            const item = currentData.find(i => i.ProjNr.toString() === projNr);
                            if (item) {
                                item.Status = 'synced';
                                freshSyncs.add(projNr);
                                updateTable();
                            }
                        }, 1000);
                    });
                });
            }

            // Add event listeners
            searchInput.addEventListener('input', updateTable);
            hideProcessedCheckbox.addEventListener('change', updateTable);

            // Sorting functionality
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    const isDate = ['KDatum', 'ADatum'].includes(column);
                    const isNumber = ['KSumme', 'ASumme', 'ProjNr'].includes(column);

                    currentData.sort((a, b) => {
                        if (isDate) {
                            return new Date(a[column] || 0) - new Date(b[column] || 0);
                        } else if (isNumber) {
                            return parseFloat(a[column] || 0) - parseFloat(b[column] || 0);
                        } else {
                            return (a[column] || '').localeCompare(b[column] || '');
                        }
                    });

                    if (this.classList.contains('asc')) {
                        currentData.reverse();
                        this.classList.remove('asc');
                        this.classList.add('desc');
                    } else {
                        this.classList.remove('desc');
                        this.classList.add('asc');
                    }

                    updateTable();
                });
            });

            // Form submission
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const jsonData = Object.fromEntries(formData.entries());

                // Show loading indicators
                loadingIndicator.classList.remove('d-none');
                loadingMessage.textContent = 'Starting reports...';
                generateBtn.disabled = true;
                generateBtnSpinner.classList.remove('d-none');

                fetch('/startAllReports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        loadingIndicator.classList.add('d-none');
                        generateBtn.disabled = false;
                        generateBtnSpinner.classList.add('d-none');
                    } else {
                        loadingMessage.textContent = 'Reports started successfully. Processing data...';
                        pollForUpdates();
                    }
                });
            });

            let lastReportTime = 0;
            const REPORT_COOLDOWN = 300000; // 300 seconds in milliseconds

            function pollForUpdates() {
                const interval = setInterval(() => {
                    fetch('/reports')
                        .then(response => response.json())
                        .then(data => {
                            const allFinished = data.reports.every(
                                report => report.status === 'FinishedSuccess' || report.status === 'FinishedError'
                            );

                            // Find report with most pages
                            let maxProgress = { current: 0, total: 0 };
                            data.reports.forEach(report => {
                                if (report.message) {
                                    const pageMatch = report.message.match(/page (\d+) for report/i);
                                    const totalMatch = report.message.match(/rows=(\d+)/i);
                                    if (pageMatch && totalMatch) {
                                        const currentPage = parseInt(pageMatch[1]);
                                        const totalRows = parseInt(totalMatch[1]);
                                        const totalPages = Math.ceil(totalRows / 200); // Assuming 200 rows per page
                                        if (totalPages > maxProgress.total) {
                                            maxProgress = { current: currentPage, total: totalPages };
                                        }
                                    }
                                }
                            });

                            // Calculate and display progress
                            if (maxProgress.total > 0) {
                                const percent = Math.round((maxProgress.current / maxProgress.total) * 100);
                                loadingMessage.textContent = `Processing reports... Page ${maxProgress.current}/${maxProgress.total} (${percent}%)`;
                            }

                            if (allFinished) {
                                // Increase wait time for larger datasets
                                setTimeout(() => {
                                    fetch('/combinedData')
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data && data.combined_data && data.combined_data.length > 0) {
                                                currentData = data.combined_data.map(item => ({
                                                    ...item,
                                                    Status: item.Status || 'new'
                                                }));
                                                updateTable();
                                                updateProjNrSuggestions();
                                                clearInterval(interval);
                                                loadingIndicator.classList.add('d-none');
                                                generateBtn.disabled = false;
                                                generateBtnSpinner.classList.add('d-none');
                                                lastReportTime = Date.now();
                                            } else {
                                                // If no data, keep polling for a bit longer
                                                let retryCount = 0;
                                                const maxRetries = 3;
                                                const retryInterval = setInterval(() => {
                                                    if (retryCount >= maxRetries) {
                                                        clearInterval(retryInterval);
                                                        clearInterval(interval);
                                                        loadingIndicator.classList.add('d-none');
                                                        generateBtn.disabled = false;
                                                        generateBtnSpinner.classList.add('d-none');
                                                        return;
                                                    }
                                                    fetch('/combinedData')
                                                        .then(response => response.json())
                                                        .then(retryData => {
                                                            if (retryData && retryData.combined_data && retryData.combined_data.length > 0) {
                                                                currentData = retryData.combined_data.map(item => ({
                                                                    ...item,
                                                                    Status: item.Status || 'new'
                                                                }));
                                                                updateTable();
                                                                updateProjNrSuggestions();
                                                                clearInterval(retryInterval);
                                                                clearInterval(interval);
                                                                loadingIndicator.classList.add('d-none');
                                                                generateBtn.disabled = false;
                                                                generateBtnSpinner.classList.add('d-none');
                                                                lastReportTime = Date.now();
                                                            }
                                                            retryCount++;
                                                        });
                                                }, 3000);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error fetching combined data:', error);
                                            clearInterval(interval);
                                            loadingIndicator.classList.add('d-none');
                                            generateBtn.disabled = false;
                                            generateBtnSpinner.classList.add('d-none');
                                        });
                                }, 5000); // Increased wait time to 5 seconds
                            }
                        });
                }, 5000);
            }

            // Update form submission handler to check cooldown
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const timeSinceLastReport = Date.now() - lastReportTime;
                if (timeSinceLastReport < REPORT_COOLDOWN) {
                    const remainingSeconds = Math.ceil((REPORT_COOLDOWN - timeSinceLastReport) / 1000);
                    alert(`Please wait ${remainingSeconds} seconds before generating new reports.`);
                    return;
                }

                const formData = new FormData(this);
                const jsonData = Object.fromEntries(formData.entries());

                loadingIndicator.classList.remove('d-none');
                loadingMessage.textContent = 'Starting reports...';
                generateBtn.disabled = true;
                generateBtnSpinner.classList.remove('d-none');

                fetch('/startAllReports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        loadingIndicator.classList.add('d-none');
                        generateBtn.disabled = false;
                        generateBtnSpinner.classList.add('d-none');
                    } else {
                        loadingMessage.textContent = 'Reports started successfully. Processing data...';
                        pollForUpdates();
                    }
                });
            });

            // Added export button functionality
            document.getElementById('exportBtn').addEventListener('click', function() {
                const button = this;
                const spinner = button.querySelector('.spinner-border');
                const btnText = button.querySelector('.btn-text');

                // Disable button and show spinner
                button.disabled = true;
                spinner.classList.remove('d-none');
                btnText.textContent = 'Exporting...';

                // Trigger file download
                fetch('/export')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Export failed');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = response.headers.get('content-disposition')?.split('filename=')[1] || 'export.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    })
                    .catch(error => {
                        console.error('Export error:', error);
                        alert('Failed to export data. Please try again.');
                    })
                    .finally(() => {
                                                // Reset button state
                        button.disabled = false;
                        spinner.classList.add('d-none');
                        btnText.textContent = 'Export Data';
                    });
            });

            // Remove old company handling since we use separate pages now

            // Theme toggle functionality
            const themeToggle = document.getElementById('themeToggle');
            const htmlElement = document.documentElement;

            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlElement.setAttribute('data-bs-theme', savedTheme);
                themeToggle.checked = savedTheme === 'light';
            }

            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'light' : 'dark';
                htmlElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        });
    </script>

</body>